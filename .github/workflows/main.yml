name: Rename Game Files From zones.json

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  rename:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install Node
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Run rename script
      run: |
        node << 'EOF'
        const fs = require('fs');
        const path = require('path');

        const zonesPath = path.join(process.cwd(), "zones.json");

        if (!fs.existsSync(zonesPath)) {
          console.error("zones.json not found!");
          process.exit(1);
        }

        const zones = JSON.parse(fs.readFileSync(zonesPath, "utf8"));

        zones.forEach(entry => {
          if (!entry.url) {
            console.log(`Skipping ID ${entry.id}: no url field`);
            return;
          }

          // Extract filename from URL
          const urlParts = entry.url.split('/');
          const fileName = urlParts[urlParts.length - 1]; // e.g., 612.html
          const filePath = path.join(process.cwd(), fileName);

          if (!fs.existsSync(filePath)) {
            console.log(`Skipping ${fileName}: file not found`);
            return;
          }

          // sanitize name for filesystem
          const safeName = entry.name.replace(/[^a-zA-Z0-9._ -]/g, "").trim();
          const newFilePath = path.join(process.cwd(), `${safeName}.html`);

          console.log(`Renaming: ${fileName} -> ${safeName}.html`);
          fs.renameSync(filePath, newFilePath);
        });

        EOF

    - name: Commit and push changes
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        git add .
        git commit -m "Auto-renamed game files from zones.json" || echo "No changes to commit"
        git push
